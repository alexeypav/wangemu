name: Build Release

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-arm-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install cross-compiler
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
    
    - name: Build ARM64 terminal server
      run: |
        make -f makefile.terminal-server-aarch64 opt
    
    - name: Create release package
      run: |
        mkdir -p release-package
        cp wangemu-terminal-server-aarch64 release-package/
        cp setup-startup.sh release-package/
        cp start-wangemu.sh release-package/
        chmod +x release-package/*
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wangemu-raspberry-pi-package
        path: release-package/
        retention-days: 90
    
    - name: Upload ARM binary to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./wangemu-terminal-server-aarch64
        asset_name: wangemu-terminal-server-aarch64
        asset_content_type: application/octet-stream
    
    - name: Upload setup script to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./setup-startup.sh
        asset_name: setup-startup.sh
        asset_content_type: text/plain
    
    - name: Upload start script to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./start-wangemu.sh
        asset_name: start-wangemu.sh
        asset_content_type: text/plain